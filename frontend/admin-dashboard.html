<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Mentor-Mentee Management System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Include Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/alerts.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: auto;
        }

        .dashboard-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 24px;
            color: var(--primary-color);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .card {
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-top: 3px solid var(--primary-color);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        }

        .summary-card {
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-radius: 8px;
        }

        .blue { 
            background-color: var(--primary-color);
            border-top: none;
        }
        .orange { 
            background-color: var(--secondary-color);
            border-top: none;
        }
        .cyan { 
            background-color: var(--accent-color);
            border-top: none;
        }
        .yellow { 
            background-color: #facc15;
            border-top: none;
        }
        .red { 
            background-color: var(--danger-color);
            border-top: none;
        }

        .table-container {
            margin-top: 24px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background-color: var(--primary-color);
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: var(--blue-light);
        }
        
        tr:hover {
            background-color: var(--orange-light);
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            background-color: var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background-color: #153e75;
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #b91c1c;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 6px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-outline:hover {
            background-color: var(--blue-light);
            transform: translateY(-2px);
        }

        .stat-card {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .stat-icon {
            font-size: 2rem;
            padding: 1rem;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
        }

        .stat-content h3 {
            margin: 0;
            font-size: 0.875rem;
            color: var(--light-text);
        }

        .stat-number {
            margin: 0;
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .activity-log {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }

        .activity-item:hover {
            background-color: var(--orange-light);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-time {
            font-size: 0.75rem;
            color: var(--light-text);
        }

        .alerts-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .alert-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }
        
        .alert-item:hover {
            background-color: var(--orange-light);
        }

        .alert-item:last-child {
            border-bottom: none;
        }

        .table-responsive {
            overflow-x: auto;
        }
        
        .section-title {
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 8px;
            margin-top: 40px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .feature-card {
            text-align: center;
            padding: 24px;
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .feature-card .icon-lg {
            font-size: 3rem;
            margin-bottom: 16px;
            color: var(--secondary-color);
        }
        
        .feature-card h3 {
            color: var(--primary-color);
            margin-bottom: 8px;
        }
        
        .feature-card p {
            color: var(--light-text);
            margin-bottom: 16px;
        }
        
        .feature-card .btn {
            margin-top: auto;
        }

        @media (max-width: 768px) {
            .grid-4 {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .grid-4 {
                grid-template-columns: 1fr;
            }
        }

        .common-features {
            width: 560px; /* Extra wide for better content display */
            background: var(--background-color);
            padding: 32px; /* More breathing room */
            border-radius: 16px; /* Softer, modern rounded corners */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* Deeper shadow for depth */
            position: absolute;
            right: 32px; /* Pushed further from the edge */
            top: 140px; /* Slightly lower for better alignment */
            z-index: 20; /* Higher z-index to ensure prominence */
            border: 1px solid rgba(0, 0, 0, 0.05); /* Subtle border for definition */
        }
        
        .common-features h2 {
            font-size: 28px; /* Bigger heading */
            margin-bottom: 28px; /* More space below title */
            color: var(--primary-color);
            font-weight: 700; /* Extra bold for impact */
            letter-spacing: -0.5px; /* Slightly tighter letters for modern look */
        }
        
        .common-features .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .common-features .feature-item {
            margin-bottom: 24px; /* Bigger gap between items */
        }
        
        .common-features .feature-link {
            display: flex;
            align-items: center;
            gap: 20px; /* Wider spacing between icon and text */
            padding: 20px 24px; /* More padding for a chunkier feel */
            border-radius: 12px; /* Extra rounded for a soft look */
            color: var(--primary-color);
            text-decoration: none;
            background: white;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); /* Smoother animation */
            font-size: 20px; /* Larger text for readability */
            font-weight: 500; /* Slightly bolder text */
        }
        
        .common-features .feature-link:hover {
            background-color: var(--blue-light);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
            transform: translateY(-3px); /* More noticeable lift */
            color: var(--primary-dark); /* Slightly darker on hover */
        }
        
        .common-features .feature-link i {
            font-size: 4.5rem; /* Massive icons */
            min-width: 72px; /* Fixed width for alignment */
            text-align: center;
            color: var(--primary-color); /* Optional: Make icons match theme */
            transition: transform 0.3s ease; /* Add icon animation */
        }
        
        .common-features .feature-link:hover i {
            transform: scale(1.05); /* Slight icon grow on hover */
        }

        .form-status {
            padding: 8px 12px;
            border-radius: 4px;
            margin-bottom: 16px;
        }
        .form-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .form-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .text-right {
            text-align: right;
        }
        .mr-2 {
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <!-- Include Navigation -->
    <div id="navigation"></div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="header-left">
                    <h1>Admin Dashboard</h1>
                    <p class="admin-privilege" id="adminPrivilege">Full Access</p>
                </div>
                <div class="header-right">
                    <div class="date-time">
                        <div class="date-box">
                            <i class="fas fa-calendar"></i>
                            <span id="currentDate"></span>
                        </div>
                        <div class="time-box">
                            <i class="fas fa-clock"></i>
                            <span id="currentTime"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card primary">
                    <div class="stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Total Users</h3>
                        <p id="totalUsers">0</p>
                        <div class="stat-breakdown">
                            <span id="activeUsers">0 Active</span>
                            <span id="inactiveUsers">0 Inactive</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card success">
                    <div class="stat-icon">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Mentors</h3>
                        <p id="totalMentors">0</p>
                        <div class="stat-breakdown">
                            <span id="departmentCount">0 Departments</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card info">
                    <div class="stat-icon">
                        <i class="fas fa-user-graduate"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Mentees</h3>
                        <p id="totalMentees">0</p>
                        <div class="stat-breakdown">
                            <span id="averageAttendance">0% Avg. Attendance</span>
                        </div>
                    </div>
                </div>
                <div class="stat-card warning">
                    <div class="stat-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-content">
                        <h3>Alerts</h3>
                        <p id="pendingAlerts">0</p>
                        <div class="stat-breakdown">
                            <span id="resolvedAlerts">0 Resolved</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions-grid">
                <button class="action-btn" onclick="location.href='users.html'">
                    <i class="fas fa-user-plus"></i>
                    <span>Add New User</span>
                </button>
                <button class="action-btn" onclick="location.href='departments.html'">
                    <i class="fas fa-building"></i>
                    <span>Manage Departments</span>
                </button>
                <button class="action-btn" onclick="location.href='announcements.html'">
                    <i class="fas fa-bullhorn"></i>
                    <span>Send Announcement</span>
                </button>
                <button class="action-btn" onclick="location.href='reports.html'">
                    <i class="fas fa-chart-bar"></i>
                    <span>Generate Reports</span>
                </button>
            </div>
        </div>
    </div>

    <!-- All Users Table -->
    <div class="container">
        <div class="table-container">
            <h2 class="section-title"><i class="fas fa-users-cog"></i> All Users</h2>
            <div style="margin-bottom: 16px;">
                <button class="btn btn-primary" onclick="openModal()">
                    <i class="fas fa-user-plus"></i> Add New User
                </button>
                <select id="roleFilter" class="btn btn-outline" style="margin-left: 10px;" onchange="filterUsersByRole()">
                    <option value="all">All Roles</option>
                    <option value="mentor">Mentors</option>
                    <option value="mentee">Mentees</option>
                    <option value="admin">Admins</option>
                </select>
            </div>
            <div class="table-responsive">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>PRN ID</th>
                            <th>Role</th>
                            <th>Phone Number</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- User rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Emergency Alerts Table -->
    <div class="container">
        <div class="table-container">
            <h2 class="section-title"><i class="fas fa-exclamation-triangle"></i> Emergency Alerts</h2>
            <div class="table-responsive">
                <table id="emergencyAlertsTable">
                    <thead>
                        <tr>
                            <th>Alert ID</th>
                            <th>Communication ID</th>
                            <th>Alert Reason</th>
                            <th>Alert Status</th>
                            <th>Created At</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="emergencyAlertsTableBody">
                        <!-- Emergency alerts will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="add-user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New User</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <form id="add-user-form" onsubmit="handleAddUser(event)">
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-input" id="user-role" required>
                        <option value="mentor">Mentor</option>
                        <option value="mentee">Mentee</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="user-email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="user-password" required>
                </div>
                <div class="form-group">
                    <label class="form-label">PRN ID</label>
                    <input type="text" class="form-input" id="user-prn" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="user-phone" required>
                </div>
                <div class="form-status" id="form-status" style="margin: 10px 0; display: none;"></div>
                <div class="form-group text-right">
                    <button type="button" class="btn btn-outline mr-2" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">Add User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit User Modal -->
    <div id="edit-user-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit User</h2>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            <form id="edit-user-form" onsubmit="handleEditUser(event)">
                <input type="hidden" id="edit-user-id">
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select class="form-input" id="edit-user-role" required>
                        <option value="mentor">Mentor</option>
                        <option value="mentee">Mentee</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="edit-user-email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="edit-user-password" placeholder="Leave blank to keep current password">
                </div>
                <div class="form-group">
                    <label class="form-label">PRN ID</label>
                    <input type="text" class="form-input" id="edit-user-prn" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Phone Number</label>
                    <input type="tel" class="form-input" id="edit-user-phone">
                </div>
                <div class="form-status" id="edit-form-status" style="margin: 10px 0; display: none;"></div>
                <div class="form-group text-right">
                    <button type="button" class="btn btn-outline mr-2" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="edit-submit-btn">Update User</button>
                </div>
            </form>
        </div>
    </div>

    <div class="common-features">
        <h2>Common Features</h2>
        <ul class="feature-list">
            <li class="feature-item">
                <a href="meeting-schedule.html" class="feature-link">
                    <i class="fas fa-calendar-alt"></i> Meeting Schedule
                </a>
            </li>
            <li class="feature-item">
                <a href="student-profile.html" class="feature-link">
                    <i class="fas fa-user-graduate"></i> Student Profiles
                </a>
            </li>
            <li class="feature-item">
                <a href="communication-hub.html" class="feature-link">
                    <i class="fas fa-comments"></i> Communication Hub
                </a>
            </li>
            <li class="feature-item">
                <a href="reports.html" class="feature-link">
                    <i class="fas fa-chart-bar"></i> Reports & Achievements
                </a>
            </li>
        </ul>
    </div>

    <script>
    // Load navigation
    fetch('components/navigation.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('navigation').innerHTML = data;
        });

    // Update date and time
    function updateDateTime() {
        const now = new Date();
        document.getElementById('currentDate').textContent = now.toLocaleDateString();
        document.getElementById('currentTime').textContent = now.toLocaleTimeString();
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);

    // Update admin privilege
    function updateAdminInfo() {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const adminData = JSON.parse(localStorage.getItem('admin'));
        if (currentUser && adminData) {
            const adminInfo = adminData.find(a => a.unique_user_no === currentUser.unique_user_no);
            if (adminInfo) {
                document.getElementById('adminPrivilege').textContent = adminInfo.privilege;
            }
        }
    }
    updateAdminInfo();

    

    
    // Explicitly call updateUsersTable when the page loads 
    // and add debug logging
    console.log('Attempting to fetch and update user table data...');
    updateUsersTable().catch(error => {
        console.error('Error in updateUsersTable:', error);
    });

    // Add function to update the users table
    async function updateUsersTable() {
        console.log('updateUsersTable function called');
        const tableBody = document.getElementById('usersTableBody');
        
        if (!tableBody) {
            console.error("Users table body not found!");
            return;
        }

        tableBody.innerHTML = '<tr><td colspan="6">Loading users...</td></tr>';

        try {
            console.log('Fetching data from /api/users endpoint...');
            // Try with explicit URL including http and port
            const apiUrl = window.location.origin + '/api/users';
            console.log('Full API URL:', apiUrl);
            
            const response = await fetch(apiUrl);
            console.log('Fetch response status:', response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const users = await response.json();
            console.log('Received user data:', users);

            if (!users || users.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">No users found.</td></tr>';
                return;
            }

            tableBody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.official_mail_id}</td>
                    <td>${user.prn_id}</td>
                    <td>${user.role}</td>
                    <td>${user.phone_num || 'N/A'}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline mr-1" onclick="editUser(${user.unique_user_no})"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.unique_user_no})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error fetching users:', error);
            tableBody.innerHTML = '<tr><td colspan="6">Error loading users. Please try again later.</td></tr>';
        }
    }

    // Edit User Functions
    async function editUser(userId) {
        console.log('Edit user:', userId);
        try {
            // Show loading spinner instead of alert
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'form-status';
            loadingDiv.style.position = 'fixed';
            loadingDiv.style.top = '20px';
            loadingDiv.style.right = '20px';
            loadingDiv.style.zIndex = '9999';
            loadingDiv.style.padding = '15px 25px';
            loadingDiv.style.borderRadius = '5px';
            loadingDiv.style.backgroundColor = '#e2f3ff';
            loadingDiv.style.color = '#0066cc';
            loadingDiv.style.border = '1px solid #99ccff';
            loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading user data...';
            document.body.appendChild(loadingDiv);
            
            // Fetch user data from API
            console.log(`Fetching user data for ID ${userId}...`);
            const response = await fetch(`/api/users/${userId}`);
            console.log('Response status:', response.status);
            
            // Remove loading message
            document.body.removeChild(loadingDiv);
            
            if (!response.ok) {
                const errorData = await response.json();
                console.error('Error response:', errorData);
                throw new Error(errorData.message || 'Failed to fetch user data');
            }
            
            const userData = await response.json();
            console.log('User data received:', userData);
            
            // Populate the edit form with user data
            document.getElementById('edit-user-id').value = userData.unique_user_no;
            document.getElementById('edit-user-email').value = userData.official_mail_id;
            document.getElementById('edit-user-prn').value = userData.prn_id;
            document.getElementById('edit-user-role').value = userData.role;
            document.getElementById('edit-user-phone').value = userData.phone_num || '';
            document.getElementById('edit-user-password').value = ''; // Don't populate the password field
            
            // Show the edit modal
            openEditModal();
            
        } catch (error) {
            console.error('Error fetching user details:', error);
            alert(`Error: ${error.message}`);
        }
    }

    async function deleteUser(userId) {
        console.log('Delete user:', userId);
        
        if (confirm(`Are you sure you want to delete user ID: ${userId}?`)) {
            try {
                // Show loading indicator in the table
                const tableBody = document.getElementById('usersTableBody');
                const rows = tableBody.getElementsByTagName('tr');
                
                // Find the row with this user ID and add a visual indication
                for (let i = 0; i < rows.length; i++) {
                    const actionCell = rows[i].querySelector(`td:last-child`);
                    if (actionCell && actionCell.innerHTML.includes(`deleteUser(${userId})`)) {
                        rows[i].style.backgroundColor = "#ffeaea";
                        actionCell.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';
                        break;
                    }
                }
                
                // Send delete request to the server
                const response = await fetch(`/api/users/${userId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete user');
                }
                
                // If successful, update the table
                updateUsersTable();
                
                // Show a temporary success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'form-status success';
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '20px';
                messageDiv.style.right = '20px';
                messageDiv.style.zIndex = '9999';
                messageDiv.style.padding = '15px 25px';
                messageDiv.style.borderRadius = '5px';
                messageDiv.innerHTML = '<i class="fas fa-check-circle"></i> User deleted successfully';
                
                document.body.appendChild(messageDiv);
                
                // Remove the message after 3 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error deleting user:', error);
                
                // Show error message
                alert(`Error: ${error.message}`);
                
                // Refresh table to revert the visual change
                updateUsersTable();
            }
        }
    }

    // Add User Modal Functions
    function openModal() {
        document.getElementById('add-user-modal').style.display = 'block';
        document.getElementById('form-status').style.display = 'none';
        document.getElementById('add-user-form').reset();
    }

    function closeModal() {
        document.getElementById('add-user-modal').style.display = 'none';
    }

    // Edit User Modal Functions
    function openEditModal() {
        document.getElementById('edit-user-modal').style.display = 'block';
        document.getElementById('edit-form-status').style.display = 'none';
    }

    function closeEditModal() {
        document.getElementById('edit-user-modal').style.display = 'none';
    }

    // Handle user form submission
    async function handleAddUser(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        const statusDiv = document.getElementById('form-status');
        
        // Disable submit button and show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        statusDiv.style.display = 'none';
        
        try {
            const userData = {
                official_mail_id: document.getElementById('user-email').value,
                password: document.getElementById('user-password').value,
                role: document.getElementById('user-role').value,
                prn_id: document.getElementById('user-prn').value,
                phone_num: document.getElementById('user-phone').value,
                // Generate a simple calendar ID
                calendar_id: `calendar${Date.now()}`
            };
            
            // Send request to API
            const response = await fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(userData)
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Failed to add user');
            }
            
            // Show success message
            statusDiv.style.display = 'block';
            statusDiv.className = 'form-status success';
            statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> User added successfully!`;
            
            // Close modal after a delay
            setTimeout(() => {
                closeModal();
                updateUsersTable(); // Refresh the table
            }, 1500);
            
        } catch (error) {
            // Show error message
            statusDiv.style.display = 'block';
            statusDiv.className = 'form-status error';
            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message}`;
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Add User';
        }
    }

    // Edit User Functions
    async function handleEditUser(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById('edit-submit-btn');
        const statusDiv = document.getElementById('edit-form-status');
        const userId = document.getElementById('edit-user-id').value;
        
        // Validation
        if (!userId) {
            statusDiv.style.display = 'block';
            statusDiv.className = 'form-status error';
            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> User ID is missing`;
            return;
        }
        
        // Disable submit button and show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
        statusDiv.style.display = 'none';
        
        try {
            // Get values from the form
            const email = document.getElementById('edit-user-email').value;
            const password = document.getElementById('edit-user-password').value;
            const prn_id = document.getElementById('edit-user-prn').value;
            const role = document.getElementById('edit-user-role').value;
            const phone_num = document.getElementById('edit-user-phone').value || null;
            
            // Track which fields were successfully updated
            const updatedFields = [];
            
            // Update each field individually using dedicated endpoints
            
            // 1. Update email
            if (email) {
                try {
                    const emailResponse = await fetch(`/api/users/email/${userId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    
                    console.log('Email update response:', await emailResponse.json());
                    
                    if (emailResponse.ok) {
                        updatedFields.push('email');
                    }
                } catch (error) {
                    console.error('Error updating email:', error);
                }
            }
            
            // 2. Update role
            if (role) {
                try {
                    const roleResponse = await fetch(`/api/users/role/${userId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ role })
                    });
                    
                    console.log('Role update response:', await roleResponse.json());
                    
                    if (roleResponse.ok) {
                        updatedFields.push('role');
                    }
                } catch (error) {
                    console.error('Error updating role:', error);
                }
            }
            
            // 3. Update PRN ID
            if (prn_id) {
                try {
                    const prnResponse = await fetch(`/api/users/prn/${userId}`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prn_id })
                    });
                    
                    console.log('PRN update response:', await prnResponse.json());
                    
                    if (prnResponse.ok) {
                        updatedFields.push('PRN ID');
                    }
                } catch (error) {
                    console.error('Error updating PRN ID:', error);
                }
            }
            
            // 4. Update phone number
            try {
                const phoneResponse = await fetch(`/api/users/phone/${userId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone_num })
                });
                
                console.log('Phone update response:', await phoneResponse.json());
                
                if (phoneResponse.ok) {
                    updatedFields.push('phone number');
                }
            } catch (error) {
                console.error('Error updating phone number:', error);
            }
            
            // 5. Update password (using the original PUT endpoint for now)
            if (password) {
                try {
                    const passwordResponse = await fetch(`/api/users/${userId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });
                    
                    console.log('Password update response:', await passwordResponse.json());
                    
                    if (passwordResponse.ok) {
                        updatedFields.push('password');
                    }
                } catch (error) {
                    console.error('Error updating password:', error);
                }
            }
            
            // Check if any fields were updated successfully
            if (updatedFields.length > 0) {
                // Show success message
                statusDiv.style.display = 'block';
                statusDiv.className = 'form-status success';
                statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> Updated: ${updatedFields.join(', ')}`;
                
                // Close modal after a delay and refresh the table
                setTimeout(() => {
                    closeEditModal();
                    updateUsersTable();
                }, 1500);
            } else {
                throw new Error('No fields were updated successfully');
            }
            
        } catch (error) {
            console.error('Error in handleEditUser:', error);
            // Show error message
            statusDiv.style.display = 'block';
            statusDiv.className = 'form-status error';
            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error.message}`;
        } finally {
            // Re-enable submit button
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Update User';
        }
    }

    function filterUsersByRole() {
        const roleFilter = document.getElementById('roleFilter').value;
        const users = document.querySelectorAll('#usersTable tbody tr');
        users.forEach(row => {
            const role = row.cells[2].textContent.toLowerCase();
            if (roleFilter === 'all' || role.includes(roleFilter.toLowerCase())) {
                row.style.display = 'table-row';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Add function to update the emergency alerts table
    async function updateEmergencyAlertsTable() {
        console.log('updateEmergencyAlertsTable function called');
        const tableBody = document.getElementById('emergencyAlertsTableBody');
        
        if (!tableBody) {
            console.error("Emergency alerts table body not found!");
            return;
        }

        tableBody.innerHTML = '<tr><td colspan="6">Loading emergency alerts...</td></tr>';

        try {
            console.log('Fetching data from /api/emergency-alerts endpoint...');
            const apiUrl = window.location.origin + '/api/emergency-alerts';
            console.log('Full API URL:', apiUrl);
            
            // Add authorization header
            const response = await fetch(apiUrl, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`,
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('Fetch response status:', response.status);
            
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Access denied. Please check your authentication.');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const alerts = await response.json();
            console.log('Received emergency alerts data:', alerts);

            if (!alerts || alerts.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">No emergency alerts found.</td></tr>';
                return;
            }

            tableBody.innerHTML = alerts.map(alert => `
                <tr>
                    <td>${alert.alert_id}</td>
                    <td>${alert.comm_id}</td>
                    <td>${alert.alert_reason}</td>
                    <td>
                        <span class="alert-status ${alert.alert_status}">
                            ${alert.alert_status}
                        </span>
                    </td>
                    <td>${new Date(alert.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline mr-1" onclick="resolveEmergencyAlert(${alert.alert_id})">
                            <i class="fas fa-check"></i> Resolve
                        </button>
                    </td>
                </tr>
            `).join('');

        } catch (error) {
            console.error('Error fetching emergency alerts:', error);
            tableBody.innerHTML = `<tr><td colspan="6">Error: ${error.message}</td></tr>`;
        }
    }

    // Function to resolve an emergency alert
    async function resolveEmergencyAlert(alertId) {
        if (confirm(`Are you sure you want to resolve alert ID: ${alertId}?`)) {
            try {
                const response = await fetch(`/api/emergency-alerts/${alertId}/resolve`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 403) {
                        throw new Error('Access denied. Please check your authentication.');
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to resolve alert');
                }
                
                // Show success message
                const messageDiv = document.createElement('div');
                messageDiv.className = 'form-status success';
                messageDiv.style.position = 'fixed';
                messageDiv.style.top = '20px';
                messageDiv.style.right = '20px';
                messageDiv.style.zIndex = '9999';
                messageDiv.style.padding = '15px 25px';
                messageDiv.style.borderRadius = '5px';
                messageDiv.innerHTML = '<i class="fas fa-check-circle"></i> Alert resolved successfully';
                
                document.body.appendChild(messageDiv);
                
                // Remove the message after 3 seconds
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.parentNode.removeChild(messageDiv);
                    }
                }, 3000);
                
                // Refresh the table
                updateEmergencyAlertsTable();
                
            } catch (error) {
                console.error('Error resolving alert:', error);
                alert(`Error: ${error.message}`);
            }
        }
    }
    </script>
</body>
</html>